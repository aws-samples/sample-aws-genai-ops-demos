<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Service Management - CDE</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='16'>üé´</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='16'>üé´</text></svg>">
    <link rel="stylesheet" href="css/cde.css">
    <style>
        /* Modal Form Styles */
        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 100%;
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .form-row label {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .form-row input,
        .form-row textarea {
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-row-split {
            display: flex;
            gap: 16px;
        }
        
        .form-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .form-field label {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .form-field input,
        .form-field .dropdown {
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #ccc;
        }
        
        /* Ensure modal is properly sized */
        #createTicketModal {
            width: 600px;
            max-width: 90vw;
        }
    </style>
</head>
<body>
    <div class="window active">
        <div class="title-bar">
            <div class="title-bar-text">üé´ IT Service Management</div>
            <div class="title-bar-buttons">
                <button onclick="window.location.href='index.html'">‚Üê</button>
                <button data-minimize></button>
                <button data-maximize></button>
                <button data-close></button>
            </div>
        </div>
        
        <div class="window-body padding">
            <p><strong>IT Service Desk and Incident Management</strong></p>
            <p>Manage IT service requests, incidents, and support tickets. Create tickets, track status, and handle IT service workflows.</p>

            <div class="flex-row gap margin-bottom">
                <button class="primary" onclick="showCreateTicketModal()">Create Ticket</button>
                <button onclick="resetTickets()">Reset</button>
                <button onclick="exportTickets()">Export</button>
                <button onclick="bulkUpdate()" id="bulkUpdateBtn" disabled>Bulk Update (0 selected)</button>
            </div>

            <!-- Search and Filter Section -->
            <fieldset>
                <legend>Search & Filter</legend>
                <div class="flex-row gap">
                    <div>
                        <label>Search:</label>
                        <input type="text" id="searchInput" placeholder="Search tickets..." onkeyup="filterTickets()">
                    </div>
                    <div>
                        <label>Status:</label>
                        <select id="statusFilter" onchange="filterTickets()">
                            <option value="">All Status</option>
                            <option value="Open">Open</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                    <div>
                        <label>Priority:</label>
                        <select id="priorityFilter" onchange="filterTickets()">
                            <option value="">All Priorities</option>
                            <option value="Critical">Critical</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div>
                        <label>Category:</label>
                        <select id="categoryFilter" onchange="filterTickets()">
                            <option value="">All Categories</option>
                            <option value="Hardware Request">Hardware Request</option>
                            <option value="Software Request">Software Request</option>
                            <option value="Access Request">Access Request</option>
                            <option value="Network Issue">Network Issue</option>
                            <option value="Incident">Incident</option>
                        </select>
                    </div>
                    <button onclick="clearFilters()">Clear Filters</button>
                </div>
            </fieldset>

            <fieldset>
                <legend>Service Tickets (<span id="ticketCount">0</span>)</legend>
                <div class="list" role="listbox" aria-multiselectable="true">
                    <table class="detailed" id="ticketsTable">
                        <thead>
                            <tr>
                                <th scope="col" role="button"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th scope="col" role="button">Ticket ID</th>
                                <th scope="col" role="button">Title</th>
                                <th scope="col" role="button">Status</th>
                                <th scope="col" role="button">Priority</th>
                                <th scope="col" role="button">Category</th>
                                <th scope="col" role="button">Requester</th>
                                <th scope="col" role="button">Assignee</th>
                                <th scope="col" role="button">Created Date</th>
                                <th scope="col" role="button">Due Date</th>
                                <th scope="col" role="button">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ticketsTableBody">
                            <!-- Tickets will be populated here -->
                        </tbody>
                    </table>
                </div>
            </fieldset>
        </div>
    </div>

    <!-- Create Ticket Modal -->
    <div id="modalBackdrop" onclick="hideCreateTicketModal()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
    <div class="dialog active" id="createTicketModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 600px;">
        <div class="title-bar">
            <div class="title-bar-text">Create New Service Ticket</div>
            <div class="title-bar-buttons">
                <button data-close onclick="hideCreateTicketModal()"></button>
            </div>
        </div>
        
        <div class="window-body padding">
            <form id="createTicketForm">
                <div class="form-grid">
                    <div class="form-row">
                        <label for="ticketTitle">Title:</label>
                        <input type="text" id="ticketTitle" placeholder="Brief description of the issue or request">
                    </div>
                    
                    <div class="form-row">
                        <label for="ticketDescription">Description:</label>
                        <textarea id="ticketDescription" rows="4" placeholder="Detailed description of the issue or request" style="resize: vertical;"></textarea>
                    </div>
                    
                    <div class="form-row-split">
                        <div class="form-field">
                            <label for="ticketCategory">Category:</label>
                            <div class="dropdown">
                                <select id="ticketCategory">
                                    <option value="Hardware Request">Hardware Request</option>
                                    <option value="Software Request">Software Request</option>
                                    <option value="Access Request">Access Request</option>
                                    <option value="Network Issue">Network Issue</option>
                                    <option value="Incident">Incident</option>
                                </select>
                                <div class="dropdown-button"></div>
                            </div>
                        </div>
                        
                        <div class="form-field">
                            <label for="ticketPriority">Priority:</label>
                            <div class="dropdown">
                                <select id="ticketPriority">
                                    <option value="Low">Low</option>
                                    <option value="Medium" selected>Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                                <div class="dropdown-button"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row-split">
                        <div class="form-field">
                            <label for="ticketRequester">Requester:</label>
                            <input type="text" id="ticketRequester" placeholder="Your name">
                        </div>
                        
                        <div class="form-field">
                            <label for="ticketDueDate">Due Date:</label>
                            <input type="date" id="ticketDueDate">
                        </div>
                    </div>
                    
                    <div class="form-buttons">
                        <button type="button" onclick="hideCreateTicketModal()">Cancel</button>
                        <button type="button" class="primary" onclick="createTicket()">Create Ticket</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- General Message Modal -->
    <div id="messageModalBackdrop" onclick="hideMessageModal()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
    <div class="dialog active" id="messageModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 400px;">
        <div class="title-bar">
            <div class="title-bar-text" id="messageModalTitle">Message</div>
            <div class="title-bar-buttons">
                <button data-close onclick="hideMessageModal()"></button>
            </div>
        </div>
        
        <div class="window-body padding">
            <div id="messageModalContent">
                <!-- Message content will be populated here -->
            </div>
            
            <div class="flex-row gap margin-top">
                <button type="button" class="primary" onclick="hideMessageModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusModalBackdrop" onclick="hideStatusModal()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
    <div class="dialog active" id="statusModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 400px;">
        <div class="title-bar">
            <div class="title-bar-text" id="statusModalTitle">Update Ticket Status</div>
            <div class="title-bar-buttons">
                <button data-close onclick="hideStatusModal()"></button>
            </div>
        </div>
        
        <div class="window-body padding">
            <div id="statusModalContent">
                <!-- Status update content will be populated here -->
            </div>
            
            <fieldset>
                <legend>Select New Status</legend>
                <div style="margin: 10px 0;">
                    <input type="radio" id="statusOpen" name="newStatus" value="Open">
                    <label for="statusOpen" style="margin-left: 5px;">Open</label>
                </div>
                <div style="margin: 10px 0;">
                    <input type="radio" id="statusInProgress" name="newStatus" value="In Progress">
                    <label for="statusInProgress" style="margin-left: 5px;">In Progress</label>
                </div>
                <div style="margin: 10px 0;">
                    <input type="radio" id="statusResolved" name="newStatus" value="Resolved">
                    <label for="statusResolved" style="margin-left: 5px;">Resolved</label>
                </div>
                <div style="margin: 10px 0;">
                    <input type="radio" id="statusClosed" name="newStatus" value="Closed">
                    <label for="statusClosed" style="margin-left: 5px;">Closed</label>
                </div>
            </fieldset>
            
            <div class="flex-row gap margin-top">
                <button type="button" onclick="hideStatusModal()">Cancel</button>
                <button type="button" class="primary" onclick="applyStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
    <div id="ticketDetailsModalBackdrop" onclick="hideTicketDetailsModal()" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>
    <div class="dialog active" id="ticketDetailsModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; width: 600px;">
        <div class="title-bar">
            <div class="title-bar-text">Ticket Details</div>
            <div class="title-bar-buttons">
                <button data-close onclick="hideTicketDetailsModal()"></button>
            </div>
        </div>
        
        <div class="window-body padding">
            <div id="ticketDetailsContent">
                <!-- Ticket details will be populated here -->
            </div>
            
            <div class="flex-row gap margin-top">
                <button type="button" onclick="hideTicketDetailsModal()">Close</button>
                <button type="button" class="primary" id="ticketActionBtn" onclick="performTicketAction()" style="display: none;">Update Status</button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        let tickets = [];

        // API Configuration - Load from generated config
        let apiBaseUrl = window.APP_CONFIG ? window.APP_CONFIG.apiBaseUrl : 'https://wa0s6jimi7.execute-api.us-east-1.amazonaws.com/prod';

        let filteredTickets = [...tickets];
        let selectedTickets = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTickets().then(() => {
                renderTickets();
            });
        });

        async function loadTickets() {
            try {
                const response = await fetch(`${apiBaseUrl}/tickets`);
                if (response.ok) {
                    const ticketsData = await response.json();
                    tickets.length = 0; // Clear existing array
                    tickets.push(...ticketsData); // Add all tickets from API
                    filteredTickets = [...tickets];
                } else {
                    console.error('Failed to load tickets from API');
                    // Fallback to hardcoded tickets if API fails
                    loadFallbackTickets();
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
                // Fallback to hardcoded tickets if API fails
                loadFallbackTickets();
            }
        }

        function loadFallbackTickets() {
            const fallbackTickets = [
                {
                    id: 'INC-001234',
                    title: 'Hardware Request - John Doe - Professional Laptop Setup',
                    description: 'New employee John Doe (Engineering, Senior Developer) requires complete hardware setup including Professional Laptop 16", 27" monitor, and peripherals. Start date: 2024-02-01. Manager: Sarah Johnson. Budget approved under ENG-2024-Q1.',
                    status: 'Open',
                    priority: 'High',
                    assignee: 'Unassigned',
                    requester: 'Sarah Johnson',
                    category: 'Hardware Request',
                    createdDate: '2024-01-25',
                    updatedDate: '2024-01-25',
                    dueDate: '2024-01-31'
                },
                {
                    id: 'INC-001235',
                    title: 'Software Access - Carole Sturka - AWS Console Access',
                    description: 'Carole Sturka requires AWS Console access for the new cloud migration project. Role: Cloud Architect. Needs EC2, S3, and IAM permissions.',
                    status: 'In Progress',
                    priority: 'Medium',
                    assignee: 'IT Admin',
                    requester: 'Mike Wilson',
                    category: 'Access Request',
                    createdDate: '2024-01-24',
                    updatedDate: '2024-01-25',
                    dueDate: '2024-01-30'
                },
                {
                    id: 'INC-001236',
                    title: 'Network Issue - Marketing Department - Internet Connectivity',
                    description: 'Marketing department experiencing intermittent internet connectivity issues. Affects 15 users. Business impact: Unable to access cloud applications and email.',
                    status: 'Resolved',
                    priority: 'High',
                    assignee: 'Network Admin',
                    requester: 'Mike Ehrmantraut',
                    category: 'Network Issue',
                    createdDate: '2024-01-23',
                    updatedDate: '2024-01-24',
                    resolvedDate: '2024-01-24'
                },
                {
                    id: 'INC-001237',
                    title: 'Password Reset - Multiple Users - System Migration',
                    description: 'Bulk password reset required for 50 users after system migration. Users unable to access new authentication system.',
                    status: 'In Progress',
                    priority: 'Medium',
                    assignee: 'Security Admin',
                    requester: 'HR Department',
                    category: 'Access Request',
                    createdDate: '2024-01-25',
                    updatedDate: '2024-01-25',
                    dueDate: '2024-01-28'
                },
                {
                    id: 'INC-001238',
                    title: 'Software Installation - Finance Team - Accounting Software',
                    description: 'Install and configure new accounting software for Finance team. 8 licenses required. Integration with existing ERP system needed.',
                    status: 'Open',
                    priority: 'Low',
                    assignee: 'Unassigned',
                    requester: 'Finance Manager',
                    category: 'Software Request',
                    createdDate: '2024-01-25',
                    updatedDate: '2024-01-25',
                    dueDate: '2024-02-05'
                }
            ];
            tickets.length = 0;
            tickets.push(...fallbackTickets);
            filteredTickets = [...tickets];
        }

        async function createTicket() {
            const title = document.getElementById('ticketTitle').value;
            const description = document.getElementById('ticketDescription').value;
            const category = document.getElementById('ticketCategory').value;
            const priority = document.getElementById('ticketPriority').value;
            const requester = document.getElementById('ticketRequester').value;
            const dueDate = document.getElementById('ticketDueDate').value;
            
            if (!title || !description || !requester) {
                showMessage('Validation Error', 'Please fill in all required fields.');
                return;
            }
            
            const newTicket = {
                id: `INC-${String(Date.now()).slice(-6)}`,
                title: title,
                description: description,
                status: 'Open',
                priority: priority,
                assignee: 'Unassigned',
                requester: requester,
                category: category,
                createdDate: new Date().toISOString().split('T')[0],
                updatedDate: new Date().toISOString().split('T')[0],
                dueDate: dueDate
            };
            
            try {
                // Try to save to API
                const response = await fetch(`${apiBaseUrl}/tickets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(newTicket)
                });
                
                if (response.ok) {
                    // Reload tickets from API
                    await loadTickets();
                } else {
                    // Fallback to local storage
                    tickets.unshift(newTicket);
                }
            } catch (error) {
                console.error('Error creating ticket:', error);
                // Fallback to local storage
                tickets.unshift(newTicket);
            }
            
            filteredTickets = [...tickets];
            renderTickets();
            hideCreateTicketModal();
            showMessage('Success', `Ticket ${newTicket.id} created successfully!`);
        }

        function renderTickets() {
            const tbody = document.getElementById('ticketsTableBody');
            const ticketCount = document.getElementById('ticketCount');
            
            tbody.innerHTML = '';
            ticketCount.textContent = filteredTickets.length;
            
            filteredTickets.forEach(ticket => {
                const row = document.createElement('tr');
                
                // Create cells safely using textContent and createElement
                const checkboxCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = ticket.id;
                checkbox.onchange = updateSelection;
                checkboxCell.appendChild(checkbox);
                
                const idCell = document.createElement('td');
                const strongId = document.createElement('strong');
                strongId.textContent = ticket.id;
                idCell.appendChild(strongId);
                
                const titleCell = document.createElement('td');
                titleCell.textContent = ticket.title;
                
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.className = `status-badge status-${ticket.status.toLowerCase().replace(' ', '-')}`;
                statusSpan.textContent = ticket.status;
                statusCell.appendChild(statusSpan);
                
                const priorityCell = document.createElement('td');
                const prioritySpan = document.createElement('span');
                prioritySpan.className = `priority-badge priority-${ticket.priority.toLowerCase()}`;
                prioritySpan.textContent = ticket.priority;
                priorityCell.appendChild(prioritySpan);
                
                const categoryCell = document.createElement('td');
                categoryCell.textContent = ticket.category;
                
                const requesterCell = document.createElement('td');
                requesterCell.textContent = ticket.requester;
                
                const assigneeCell = document.createElement('td');
                assigneeCell.textContent = ticket.assignee;
                
                const createdCell = document.createElement('td');
                createdCell.textContent = new Date(ticket.createdDate).toLocaleDateString();
                
                const dueCell = document.createElement('td');
                dueCell.textContent = ticket.dueDate ? new Date(ticket.dueDate).toLocaleDateString() : '-';
                
                const actionsCell = document.createElement('td');
                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'View';
                viewBtn.style.fontSize = '12px';
                viewBtn.onclick = () => viewTicket(ticket.id);
                
                const updateBtn = document.createElement('button');
                updateBtn.textContent = 'Update';
                updateBtn.style.fontSize = '12px';
                updateBtn.onclick = () => updateTicketStatus(ticket.id);
                
                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(document.createTextNode(' '));
                actionsCell.appendChild(updateBtn);
                
                // Append all cells to row
                row.appendChild(checkboxCell);
                row.appendChild(idCell);
                row.appendChild(titleCell);
                row.appendChild(statusCell);
                row.appendChild(priorityCell);
                row.appendChild(categoryCell);
                row.appendChild(requesterCell);
                row.appendChild(assigneeCell);
                row.appendChild(createdCell);
                row.appendChild(dueCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        function filterTickets() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            filteredTickets = tickets.filter(ticket => {
                const matchesSearch = !searchTerm || 
                    ticket.title.toLowerCase().includes(searchTerm) ||
                    ticket.description.toLowerCase().includes(searchTerm) ||
                    ticket.id.toLowerCase().includes(searchTerm) ||
                    ticket.requester.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || ticket.status === statusFilter;
                const matchesPriority = !priorityFilter || ticket.priority === priorityFilter;
                const matchesCategory = !categoryFilter || ticket.category === categoryFilter;
                
                return matchesSearch && matchesStatus && matchesPriority && matchesCategory;
            });
            
            renderTickets();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            filteredTickets = [...tickets];
            renderTickets();
        }

        function showCreateTicketModal() {
            document.getElementById('modalBackdrop').style.display = 'block';
            document.getElementById('createTicketModal').style.display = 'block';
            
            // Set default due date to 7 days from now
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 7);
            document.getElementById('ticketDueDate').value = dueDate.toISOString().split('T')[0];
        }

        function hideCreateTicketModal() {
            document.getElementById('modalBackdrop').style.display = 'none';
            document.getElementById('createTicketModal').style.display = 'none';
            document.getElementById('createTicketForm').reset();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#ticketsTableBody input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateSelection();
        }

        function updateSelection() {
            const checkboxes = document.querySelectorAll('#ticketsTableBody input[type="checkbox"]:checked');
            selectedTickets = Array.from(checkboxes).map(cb => cb.value);
            
            const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
            bulkUpdateBtn.disabled = selectedTickets.length === 0;
            bulkUpdateBtn.textContent = `Bulk Update (${selectedTickets.length} selected)`;
        }

        function viewTicket(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (ticket) {
                showTicketDetails(ticket);
            }
        }

        function updateTicketStatus(ticketId) {
            const ticket = tickets.find(t => t.id === ticketId);
            if (ticket) {
                showStatusModal([ticketId], ticket.status);
            }
        }

        function bulkUpdate() {
            if (selectedTickets.length === 0) return;
            
            showStatusModal(selectedTickets, null);
        }

        function resetTickets() {
            // Reset to original fallback data
            tickets.length = 0; // Clear current tickets
            loadFallbackTickets(); // Reload original data
            filteredTickets = [...tickets];
            renderTickets();
            
            // Clear any selections
            document.getElementById('selectAll').checked = false;
            selectedTickets = [];
            updateSelection();
            
            // Clear any filters
            clearFilters();
            
            showMessage('Success', 'Environment reset to original state! All created tickets and changes have been cleared.');
        }

        function refreshTickets() {
            // Simulate refreshing data (keeps current state but updates timestamps)
            tickets.forEach(ticket => {
                ticket.updatedDate = new Date().toISOString().split('T')[0];
            });
            
            filteredTickets = [...tickets];
            renderTickets();
            showMessage('Success', 'Tickets refreshed! In a real system, this would fetch the latest data from the server.');
        }

        function exportTickets() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Ticket ID,Title,Status,Priority,Category,Requester,Assignee,Created Date,Due Date\n" +
                filteredTickets.map(ticket => 
                    `"${ticket.id}","${ticket.title}","${ticket.status}","${ticket.priority}","${ticket.category}","${ticket.requester}","${ticket.assignee}","${ticket.createdDate}","${ticket.dueDate || ''}"`
                ).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "tickets_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Modal functions
        function showMessage(title, message) {
            document.getElementById('messageModalTitle').textContent = title;
            const messageContent = document.getElementById('messageModalContent');
            messageContent.innerHTML = ''; // Clear existing content
            const paragraph = document.createElement('p');
            paragraph.textContent = message; // Use textContent to prevent XSS
            messageContent.appendChild(paragraph);
            document.getElementById('messageModalBackdrop').style.display = 'block';
            document.getElementById('messageModal').style.display = 'block';
        }

        function hideMessageModal() {
            document.getElementById('messageModalBackdrop').style.display = 'none';
            document.getElementById('messageModal').style.display = 'none';
        }

        function showTicketDetails(ticket) {
            const detailsContent = document.getElementById('ticketDetailsContent');
            const actionBtn = document.getElementById('ticketActionBtn');
            
            // Clear existing content
            detailsContent.innerHTML = '';
            
            // Create fieldset
            const fieldset = document.createElement('fieldset');
            const legend = document.createElement('legend');
            legend.textContent = 'Ticket Information';
            fieldset.appendChild(legend);
            
            // Helper function to create field rows
            function createFieldRow(labelText, value, isDescription = false) {
                const fieldRow = document.createElement('div');
                fieldRow.className = 'field-row';
                
                const label = document.createElement('label');
                label.style.width = '120px';
                label.style.display = 'inline-block';
                label.style.textAlign = 'right';
                const strong = document.createElement('strong');
                strong.textContent = labelText + ':';
                label.appendChild(strong);
                fieldRow.appendChild(label);
                
                if (isDescription) {
                    const descDiv = document.createElement('div');
                    descDiv.style.marginLeft = '8px';
                    descDiv.style.border = '1px solid #ccc';
                    descDiv.style.padding = '8px';
                    descDiv.style.background = '#f9f9f9';
                    descDiv.style.maxHeight = '100px';
                    descDiv.style.overflowY = 'auto';
                    descDiv.textContent = value;
                    fieldRow.appendChild(descDiv);
                } else {
                    const span = document.createElement('span');
                    span.style.marginLeft = '8px';
                    span.textContent = value;
                    fieldRow.appendChild(span);
                }
                
                return fieldRow;
            }
            
            // Helper function to create colored field rows
            function createColoredFieldRow(labelText, value, color) {
                const fieldRow = document.createElement('div');
                fieldRow.className = 'field-row';
                
                const label = document.createElement('label');
                label.style.width = '120px';
                label.style.display = 'inline-block';
                label.style.textAlign = 'right';
                const strong = document.createElement('strong');
                strong.textContent = labelText + ':';
                label.appendChild(strong);
                fieldRow.appendChild(label);
                
                const span = document.createElement('span');
                span.style.marginLeft = '8px';
                span.style.fontWeight = 'bold';
                span.style.color = color;
                span.textContent = value;
                fieldRow.appendChild(span);
                
                return fieldRow;
            }
            
            // Add all fields
            fieldset.appendChild(createFieldRow('Ticket ID', ticket.id));
            fieldset.appendChild(createFieldRow('Title', ticket.title));
            fieldset.appendChild(createFieldRow('Description', ticket.description, true));
            fieldset.appendChild(createColoredFieldRow('Status', ticket.status, getTicketStatusColor(ticket.status)));
            fieldset.appendChild(createColoredFieldRow('Priority', ticket.priority, getPriorityColor(ticket.priority)));
            fieldset.appendChild(createFieldRow('Category', ticket.category));
            fieldset.appendChild(createFieldRow('Requester', ticket.requester));
            fieldset.appendChild(createFieldRow('Assignee', ticket.assignee));
            fieldset.appendChild(createFieldRow('Created Date', new Date(ticket.createdDate).toLocaleDateString()));
            
            if (ticket.dueDate) {
                fieldset.appendChild(createFieldRow('Due Date', new Date(ticket.dueDate).toLocaleDateString()));
            }
            
            detailsContent.appendChild(fieldset);
                    <div class="field-row">
                        <label style="width: 120px; display: inline-block; text-align: right;"><strong>Due Date:</strong></label>
                        <span style="margin-left: 8px;">${ticket.dueDate ? new Date(ticket.dueDate).toLocaleDateString() : 'Not set'}</span>
                    </div>
                </fieldset>
            `;
            
            // Show action button if ticket can be updated
            if (ticket.status !== 'Closed' && ticket.status !== 'Resolved') {
                actionBtn.style.display = 'inline-block';
                actionBtn.setAttribute('data-ticket-id', ticket.id);
            } else {
                actionBtn.style.display = 'none';
            }
            
            document.getElementById('ticketDetailsModalBackdrop').style.display = 'block';
            document.getElementById('ticketDetailsModal').style.display = 'block';
        }

        function hideTicketDetailsModal() {
            document.getElementById('ticketDetailsModalBackdrop').style.display = 'none';
            document.getElementById('ticketDetailsModal').style.display = 'none';
        }

        function performTicketAction() {
            const actionBtn = document.getElementById('ticketActionBtn');
            const ticketId = actionBtn.getAttribute('data-ticket-id');
            updateTicketStatus(ticketId);
            hideTicketDetailsModal();
        }

        function getTicketStatusColor(status) {
            switch(status) {
                case 'Open': return '#0066cc';
                case 'In Progress': return '#ff9900';
                case 'Resolved': return '#009900';
                case 'Closed': return '#666666';
                default: return '#000000';
            }
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'Critical': return '#cc0000';
                case 'High': return '#ff6600';
                case 'Medium': return '#0066cc';
                case 'Low': return '#009900';
                default: return '#000000';
            }
        }

        // Status update modal functions
        let currentStatusUpdateTickets = [];

        function showStatusModal(ticketIds, currentStatus) {
            currentStatusUpdateTickets = ticketIds;
            const statusContent = document.getElementById('statusModalContent');
            const statusTitle = document.getElementById('statusModalTitle');
            
            // Clear existing content
            statusContent.innerHTML = '';
            
            if (ticketIds.length === 1) {
                const ticket = tickets.find(t => t.id === ticketIds[0]);
                statusTitle.textContent = `Update Status - ${ticketIds[0]}`;
                
                // Create ticket info paragraph
                const ticketPara = document.createElement('p');
                const ticketStrong = document.createElement('strong');
                ticketStrong.textContent = 'Ticket: ';
                ticketPara.appendChild(ticketStrong);
                ticketPara.appendChild(document.createTextNode(ticket.title));
                statusContent.appendChild(ticketPara);
                
                // Create current status paragraph
                const statusPara = document.createElement('p');
                const statusStrong = document.createElement('strong');
                statusStrong.textContent = 'Current Status: ';
                statusPara.appendChild(statusStrong);
                
                const statusSpan = document.createElement('span');
                statusSpan.style.color = getTicketStatusColor(ticket.status);
                statusSpan.style.fontWeight = 'bold';
                statusSpan.textContent = ticket.status;
                statusPara.appendChild(statusSpan);
                statusContent.appendChild(statusPara);
                
                // Pre-select current status
                const currentRadio = document.querySelector(`input[name="newStatus"][value="${ticket.status}"]`);
                if (currentRadio) {
                    currentRadio.checked = true;
                }
            } else {
                statusTitle.textContent = `Bulk Update Status - ${ticketIds.length} tickets`;
                
                // Create bulk update info
                const bulkPara1 = document.createElement('p');
                const bulkStrong = document.createElement('strong');
                bulkStrong.textContent = `Updating ${ticketIds.length} selected tickets`;
                bulkPara1.appendChild(bulkStrong);
                statusContent.appendChild(bulkPara1);
                
                const bulkPara2 = document.createElement('p');
                bulkPara2.textContent = 'Choose the new status to apply to all selected tickets:';
                statusContent.appendChild(bulkPara2);
                
                // Clear any pre-selection for bulk updates
                document.querySelectorAll('input[name="newStatus"]').forEach(radio => {
                    radio.checked = false;
                });
            }
            
            document.getElementById('statusModalBackdrop').style.display = 'block';
            document.getElementById('statusModal').style.display = 'block';
        }

        function hideStatusModal() {
            document.getElementById('statusModalBackdrop').style.display = 'none';
            document.getElementById('statusModal').style.display = 'none';
            currentStatusUpdateTickets = [];
            
            // Clear radio selections
            document.querySelectorAll('input[name="newStatus"]').forEach(radio => {
                radio.checked = false;
            });
        }

        function applyStatusUpdate() {
            const selectedStatus = document.querySelector('input[name="newStatus"]:checked');
            
            if (!selectedStatus) {
                showMessage('Error', 'Please select a status to update.');
                return;
            }
            
            const newStatus = selectedStatus.value;
            let updatedCount = 0;
            let previousStatus = '';
            
            currentStatusUpdateTickets.forEach(ticketId => {
                const ticket = tickets.find(t => t.id === ticketId);
                if (ticket) {
                    // Capture previous status for single ticket updates
                    if (currentStatusUpdateTickets.length === 1) {
                        previousStatus = ticket.status;
                    }
                    
                    ticket.status = newStatus;
                    ticket.updatedDate = new Date().toISOString().split('T')[0];
                    
                    if (newStatus === 'Resolved' || newStatus === 'Closed') {
                        ticket.resolvedDate = new Date().toISOString().split('T')[0];
                    }
                    updatedCount++;
                }
            });
            
            filteredTickets = [...tickets];
            renderTickets();
            
            // Clear selection if it was a bulk update
            if (currentStatusUpdateTickets.length > 1) {
                document.getElementById('selectAll').checked = false;
                selectedTickets = [];
                updateSelection();
            }
            
            hideStatusModal();
            
            if (updatedCount === 1) {
                showMessage('Success', `Ticket ${currentStatusUpdateTickets[0]} status updated from "${previousStatus}" to "${newStatus}"`);
            } else {
                showMessage('Success', `${updatedCount} tickets updated to: ${newStatus}`);
            }
        }
    </script>
</body>
</html>